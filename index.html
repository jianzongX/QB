<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>在线做题系统</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;max-width:900px;margin:0 auto;padding:20px;line-height:1.6;background-color:#f5f7fa;color:#333}
        h1,h2{color:#2c3e50;text-align:center;margin-bottom:20px}
        .upload-section,.quiz-section,.result-section{background:#fff;padding:25px;margin-bottom:25px;border-radius:8px;box-shadow:0 3px 10px rgba(0,0,0,.08)}
        button{background:#3498db;color:#fff;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;font-size:16px;transition:all 0.3s}
        button:hover{background:#2980b9;transform:translateY(-2px)}
        button.secondary{background:#95a5a6}
        button.secondary:hover{background:#7f8c8d}
        button.success{background:#2ecc71}
        button.success:hover{background:#27ae60}
        button.danger{background:#e74c3c}
        button.danger:hover{background:#c0392b}
        .option{margin:10px 0;padding:8px 12px;border-radius:4px;border:1px solid #ddd;transition:background 0.2s}
        .option:hover{background:#f1f8ff}
        .correct{color:#27ae60;font-weight:bold;background:#e8f5e9}
        .incorrect{color:#e74c3c;background:#ffebee}
        .score{font-size:28px;font-weight:bold;text-align:center;margin:25px 0;color:#2c3e50}
        table{width:100%;border-collapse:collapse;margin:20px 0}
        th,td{border:1px solid #ddd;padding:10px;text-align:left}
        th{background:#f2f7fb;color:#2c3e50}
        .hidden{display:none !important;}
        
        /* 题目序号点击样式 */
        .question-number {
            color: #3498db;
            cursor: pointer;
            text-decoration: underline;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .question-number:hover {
            color: #2980b9;
            background-color: #eaf2f8;
        }
        
        /* 模态框样式 */
        #questionModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.4em;
            color: #2c3e50;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
        }
        
        .modal-body {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .answer-info {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        /* 正确答案显示区域 */
        .correct-answer-display {
            margin-top: 15px;
            padding: 12px;
            background-color: #e8f5e9;
            border-left: 4px solid #2ecc71;
            border-radius: 4px;
        }
        
        .correct-answer-display strong {
            color: #27ae60;
        }
        
        /* 范围选择样式 */
        .range-selection {
            margin: 20px 0;
            padding: 20px;
            background-color: #f1f8e9;
            border-radius: 8px;
            border-left: 4px solid #7cb342;
        }
        
        .range-inputs {
            display: flex;
            gap: 12px;
            align-items: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .range-inputs input {
            width: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .range-info {
            color: #555;
            font-size: 0.95em;
            margin-top: 8px;
        }
        
        /* 上传说明样式 */
        .upload-instructions {
            margin-top: 15px;
            padding: 15px;
            background-color: #fff8e1;
            border-left: 4px solid #ffb300;
            border-radius: 4px;
        }
        
        /* 结果筛选器 */
        .result-filter {
            margin: 20px 0;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: #3498db;
            color: white;
        }
        
        /* 错题统计 */
        .wrong-stats {
            background: #ffebee;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #e74c3c;
        }
        
        /* 进度条 */
        .progress-bar {
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #3498db;
            border-radius: 5px;
            transition: width 0.3s;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .range-inputs {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .result-filter {
                flex-direction: column;
            }
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        /* 文件上传样式 */
        .file-input-container {
            position: relative;
            margin: 20px 0;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 12px 20px;
            background: #3498db;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .file-input-label:hover {
            background: #2980b9;
        }
        
        #fileInput {
            position: absolute;
            left: -9999px;
        }
        
        .file-name {
            margin-left: 15px;
            font-style: italic;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <h1>在线做题系统</h1>

    <div id="uploadSection" class="upload-section fade-in">
        <h2>1. 上传 Excel 题库</h2>
        <div class="file-input-container">
            <label for="fileInput" class="file-input-label">选择 Excel 文件</label>
            <input type="file" id="fileInput" accept=".xls,.xlsx">
            <span id="fileName" class="file-name">未选择文件</span>
        </div>
        <button id="uploadBtn" class="success">上传</button>
        
        <div class="upload-instructions">
            <p><strong>上传说明：</strong></p>
            <p>1. Excel文件第一行为标题行，第二行为示例，从第三行开始为题目</p>
            <p>2. 第一列为题型（单选、多选、判断），第二列为题目内容，后续列为选项，最后一列为正确答案</p>
            <p>3. 判断题答案请使用"T"或"F"（或用"A"/"B"表示）</p>
        </div>
    </div>

    <div id="quizSection" class="quiz-section hidden">
        <h2>2. 开始测试</h2>
        <div class="range-selection">
            <label><strong>请选择题目范围：</strong></label>
            <div class="range-inputs">
                <input type="number" id="startRange" min="1" value="1" placeholder="开始题号">
                <span>至</span>
                <input type="number" id="endRange" min="1" value="10" placeholder="结束题号">
            </div>
            <p class="range-info">当前题库共有 <span id="totalQuestionsCount">0</span> 道题（已跳过前两行标题）</p>
            <p class="range-info">提示：选择范围后，系统将在该范围内随机打乱顺序出题</p>
        </div>
        <button id="startQuizBtn" class="success">开始测试</button>

        <div id="quizArea" class="hidden">
            <div class="progress-bar">
                <div class="progress" id="progressBar" style="width: 0%"></div>
            </div>
            <p>题目 <span id="current">1</span> / <span id="total">10</span></p>
            <div id="questionText" style="font-size: 18px; font-weight: bold; margin: 15px 0;"></div>
            <div id="options" class="options"></div>
            
            <!-- 正确答案显示区域 -->
            <div id="correctAnswerDisplay" class="correct-answer-display hidden">
                <strong>正确答案：</strong><span id="correctAnswerText"></span>
            </div>
            
            <div style="margin-top: 25px; display: flex; gap: 10px;">
                <button id="submitBtn">提交答案</button>
                <button id="nextBtn" class="hidden">下一题</button>
            </div>
        </div>
    </div>

    <div id="resultSection" class="result-section hidden">
        <h2>3. 测试结果</h2>
        <div class="score">得分：<span id="score">0</span> / <span id="max">0</span></div>
        
        <div class="wrong-stats">
            <h3>错题统计</h3>
            <p>共答错 <span id="wrongCount">0</span> 题，正确率 <span id="accuracy">0</span>%</p>
        </div>
        
        <div class="result-filter">
            <span>显示选项：</span>
            <button id="showAllBtn" class="filter-btn secondary">所有题目</button>
            <button id="showWrongBtn" class="filter-btn active">只显示错题</button>
        </div>
        
        <div id="detail"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button id="restartBtn" class="success">重新开始</button>
            <button id="reviewWrongBtn" class="secondary">复习错题</button>
        </div>
    </div>

    <!-- 题目详情模态框 -->
    <div id="questionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">题目详情</h3>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- 题目详情将在这里动态加载 -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="closeModalBtn" class="secondary">关闭</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // 全局变量
        let allQuestions = [];
        let currentQuestions = [];
        let currentIndex = 0;
        let userScore = 0;
        let userAnswers = [];
        let showAllResults = false; // 控制结果显示模式

        // DOM 元素引用
        const elements = {
            uploadSection: document.getElementById('uploadSection'),
            quizSection: document.getElementById('quizSection'),
            resultSection: document.getElementById('resultSection'),
            fileInput: document.getElementById('fileInput'),
            fileName: document.getElementById('fileName'),
            uploadBtn: document.getElementById('uploadBtn'),
            // 范围选择元素
            startRange: document.getElementById('startRange'),
            endRange: document.getElementById('endRange'),
            totalQuestionsCount: document.getElementById('totalQuestionsCount'),
            // 其他元素
            startQuizBtn: document.getElementById('startQuizBtn'),
            quizArea: document.getElementById('quizArea'),
            currentQuestion: document.getElementById('current'),
            totalQuestions: document.getElementById('total'),
            questionText: document.getElementById('questionText'),
            options: document.getElementById('options'),
            submitBtn: document.getElementById('submitBtn'),
            nextBtn: document.getElementById('nextBtn'),
            score: document.getElementById('score'),
            maxScore: document.getElementById('max'),
            detail: document.getElementById('detail'),
            restartBtn: document.getElementById('restartBtn'),
            questionModal: document.getElementById('questionModal'),
            modalContent: document.getElementById('modalContent'),
            closeModal: document.getElementById('closeModal'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            // 正确答案显示区域
            correctAnswerDisplay: document.getElementById('correctAnswerDisplay'),
            correctAnswerText: document.getElementById('correctAnswerText'),
            // 进度条
            progressBar: document.getElementById('progressBar'),
            // 结果显示控制
            showAllBtn: document.getElementById('showAllBtn'),
            showWrongBtn: document.getElementById('showWrongBtn'),
            // 错题统计
            wrongCount: document.getElementById('wrongCount'),
            accuracy: document.getElementById('accuracy'),
            // 复习错题按钮
            reviewWrongBtn: document.getElementById('reviewWrongBtn')
        };

        // 初始化函数
        function init() {
            // 确保模态框默认隐藏
            elements.questionModal.style.display = 'none';
            // 绑定所有事件监听器
            bindEventListeners();
        }

        // 绑定事件监听器
        function bindEventListeners() {
            // 上传按钮点击事件
            elements.uploadBtn.addEventListener('click', handleUpload);
            
            // 文件选择变化事件
            elements.fileInput.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    elements.fileName.textContent = this.files[0].name;
                } else {
                    elements.fileName.textContent = '未选择文件';
                }
            });
            
            // 开始测试按钮点击事件
            elements.startQuizBtn.addEventListener('click', startQuiz);
            
            // 提交答案按钮点击事件
            elements.submitBtn.addEventListener('click', submitAnswer);
            
            // 下一题按钮点击事件
            elements.nextBtn.addEventListener('click', goToNextQuestion);
            
            // 重新开始按钮点击事件
            elements.restartBtn.addEventListener('click', restart);
            
            // 复习错题按钮点击事件
            elements.reviewWrongBtn.addEventListener('click', reviewWrongQuestions);
            
            // 关闭模态框按钮点击事件
            elements.closeModal.addEventListener('click', hideModal);
            elements.closeModalBtn.addEventListener('click', hideModal);
            
            // 点击模态框外部关闭
            elements.questionModal.addEventListener('click', function(e) {
                if (e.target === elements.questionModal) {
                    hideModal();
                }
            });
            
            // 结果显示控制
            elements.showAllBtn.addEventListener('click', function() {
                showAllResults = true;
                elements.showAllBtn.classList.add('active');
                elements.showWrongBtn.classList.remove('active');
                renderResults();
            });
            
            elements.showWrongBtn.addEventListener('click', function() {
                showAllResults = false;
                elements.showAllBtn.classList.remove('active');
                elements.showWrongBtn.classList.add('active');
                renderResults();
            });
        }

        // 处理文件上传（核心修改：仅通过用户主动上传获取文件，不读取本地预存文件）
        function handleUpload() {
            const file = elements.fileInput.files[0];
            if (!file) {
                alert('请选择Excel题库文件');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    
                    // 处理题库数据，跳过前两行
                    allQuestions = processExcelData(rawData);
                    
                    if (allQuestions.length === 0) {
                        alert('未从Excel中解析到有效题目，请检查文件格式是否正确，题目应从第三行开始');
                        return;
                    }
                    
                    // 显示题库总题数
                    elements.totalQuestionsCount.textContent = allQuestions.length;
                    
                    // 默认范围设置为1到总题数或10（取较小值）
                    const defaultEnd = Math.min(allQuestions.length, 10);
                    elements.startRange.value = 1;
                    elements.endRange.value = defaultEnd;
                    
                    // 限制范围输入的最大值
                    elements.startRange.max = allQuestions.length;
                    elements.endRange.max = allQuestions.length;
                    
                    // 切换到测验区域
                    elements.uploadSection.classList.add('hidden');
                    elements.quizSection.classList.remove('hidden');
                } catch (err) {
                    alert('解析失败：' + err.message);
                    console.error('Excel解析错误:', err);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 处理Excel数据 - 跳过前两行，从第三行开始读取题目
        function processExcelData(data) {
            const questions = [];
            
            // 从索引2开始处理（第三行），跳过索引0（第一行）和索引1（第二行）
            for (let i = 2; i < data.length; i++) {
                const row = data[i];
                // 跳过空行或无效行
                if (!row || row.length < 3) continue;
                
                const type = (row[0] || '').trim();
                const text = row[1] || '';
                let answer = String(row[row.length - 1] || '').trim().toUpperCase();
                
                // 处理判断题答案转换
                if (type === '判断') {
                    if (answer === 'T' || answer === '对' || answer === '正确') {
                        answer = 'A';
                    } else if (answer === 'F' || answer === '错' || answer === '错误') {
                        answer = 'B';
                    }
                }
                
                const options = [];
                if (type === '判断') {
                    options.push({ letter: 'A', text: '对' });
                    options.push({ letter: 'B', text: '错' });
                } else {
                    let optIdx = 2;
                    while (optIdx < row.length - 1 && row[optIdx]) {
                        options.push({ 
                            letter: String.fromCharCode(65 + optIdx - 2), 
                            text: row[optIdx] 
                        });
                        optIdx++;
                    }
                }
                
                // 记录原始题号（从1开始计数，相对于题目内容）
                questions.push({ 
                    type, 
                    text, 
                    options, 
                    answer,
                    originalIndex: questions.length + 1 // 从1开始编号
                });
            }
            
            return questions;
        }

        // 格式化答案显示 - 判断题显示为A（T）、B（F）
        function formatAnswer(question, answer) {
            if (question.type === '判断') {
                // 替换A为A（T），B为B（F）
                return answer.replace(/A/g, 'T').replace(/B/g, 'F');
            }
            return answer;
        }

        // 开始测验 - 根据范围选择题目并打乱顺序
        function startQuiz() {
            // 获取用户选择的范围
            const start = parseInt(elements.startRange.value);
            const end = parseInt(elements.endRange.value);
            
            // 验证范围有效性
            if (isNaN(start) || isNaN(end) || start < 1 || end < 1) {
                alert('请输入有效的范围');
                return;
            }
            
            if (start > end) {
                alert('开始题号不能大于结束题号');
                return;
            }
            
            if (end > allQuestions.length) {
                alert(`结束题号不能大于题库总题数(${allQuestions.length})`);
                return;
            }
            
            // 根据范围筛选题目
            const filteredQuestions = allQuestions.filter(
                (q) => q.originalIndex >= start && q.originalIndex <= end
            );
            
            if (filteredQuestions.length === 0) {
                alert('所选范围内没有题目，请重新选择');
                return;
            }
            
            // 在筛选范围内打乱题目顺序
            currentQuestions = [...filteredQuestions].sort(() => Math.random() - 0.5);
            
            currentIndex = 0;
            userScore = 0;
            userAnswers = [];
            
            // 显示测验区域
            elements.quizArea.classList.remove('hidden');
            elements.totalQuestions.textContent = currentQuestions.length;
            updateProgressBar();
            showCurrentQuestion();
        }

        // 更新进度条
        function updateProgressBar() {
            const progress = ((currentIndex) / currentQuestions.length) * 100;
            elements.progressBar.style.width = `${progress}%`;
        }

        // 显示当前题目
        function showCurrentQuestion() {
            const question = currentQuestions[currentIndex];
            elements.currentQuestion.textContent = currentIndex + 1;
            elements.questionText.textContent = question.text;
            elements.options.innerHTML = '';
            
            // 隐藏正确答案显示区域和下一题按钮，显示提交按钮
            elements.correctAnswerDisplay.classList.add('hidden');
            elements.nextBtn.classList.add('hidden');
            elements.submitBtn.classList.remove('hidden');
            
            // 重置选项样式和状态
            question.options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                
                const input = document.createElement('input');
                input.type = question.type === '多项选择' ? 'checkbox' : 'radio';
                input.name = question.type === '多项选择' ? `ans-${currentIndex}` : 'ans';
                input.value = option.letter;
                input.id = `opt-${currentIndex}-${option.letter}`;
                
                const label = document.createElement('label');
                label.htmlFor = `opt-${currentIndex}-${option.letter}`;
                label.textContent = `${option.letter}. ${option.text}`;
                
                optionDiv.appendChild(input);
                optionDiv.appendChild(label);
                elements.options.appendChild(optionDiv);
            });
        }

        // 提交答案
        function submitAnswer() {
            const question = currentQuestions[currentIndex];
            let userAnswer = '';
            
            if (question.type === '多项选择') {
                const checkedOptions = [...document.querySelectorAll(`input[name="ans-${currentIndex}"]:checked`)];
                userAnswer = checkedOptions.map(opt => opt.value).sort().join('');
            } else {
                const selectedOption = document.querySelector('input[name="ans"]:checked');
                if (!selectedOption) {
                    alert('请选择答案');
                    return;
                }
                userAnswer = selectedOption.value;
            }
            
            // 验证答案
            const correctAnswer = question.answer.toUpperCase();
            const isCorrect = userAnswer === correctAnswer;
            
            // 记录答案 - 存储原始答案，显示时再格式化
            userAnswers.push({
                question: question,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect
            });
            
            // 更新分数
            if (isCorrect) {
                userScore++;
            } else {
                // 错误时显示格式化后的正确答案
                elements.correctAnswerText.textContent = formatAnswer(question, correctAnswer);
                elements.correctAnswerDisplay.classList.remove('hidden');
            }
            
            // 标记正确和错误答案
            question.options.forEach(option => {
                const label = document.querySelector(`label[for="opt-${currentIndex}-${option.letter}"]`);
                const input = document.querySelector(`input[id="opt-${currentIndex}-${option.letter}"]`);
                
                if (label && input) {
                    // 禁用所有选项，防止再次修改
                    input.disabled = true;
                    
                    if (option.letter === correctAnswer) {
                        label.classList.add('correct');
                    } else if (userAnswer.includes(option.letter)) {
                        label.classList.add('incorrect');
                    }
                }
            });
            
            // 隐藏提交按钮，显示下一题按钮
            elements.submitBtn.classList.add('hidden');
            elements.nextBtn.classList.remove('hidden');
        }

        // 前往下一题
        function goToNextQuestion() {
            currentIndex++;
            updateProgressBar();
            if (currentIndex < currentQuestions.length) {
                showCurrentQuestion();
            } else {
                showResults();
            }
        }

        // 显示结果
        function showResults() {
            // 隐藏测验区域，显示结果区域
            elements.quizSection.classList.add('hidden');
            elements.resultSection.classList.remove('hidden');
            
            // 更新分数
            elements.score.textContent = userScore;
            elements.maxScore.textContent = currentQuestions.length;
            
            // 计算错题数量和正确率
            const wrongCount = currentQuestions.length - userScore;
            const accuracy = ((userScore / currentQuestions.length) * 100).toFixed(1);
            
            elements.wrongCount.textContent = wrongCount;
            elements.accuracy.textContent = accuracy;
            
            // 渲染结果
            renderResults();
        }

        // 渲染结果表格
        function renderResults() {
            // 生成结果表格
            let tableHtml = '<table><tr><th>题号</th><th>原始题号</th><th>你的答案</th><th>正确答案</th><th>结果</th></tr>';
            
            let displayedCount = 0;
            
            userAnswers.forEach((answer, index) => {
                // 如果只显示错题且这道题答对了，跳过
                if (!showAllResults && answer.isCorrect) {
                    return;
                }
                
                displayedCount++;
                
                // 对答案进行格式化显示
                const formattedUserAnswer = formatAnswer(answer.question, answer.userAnswer);
                const formattedCorrectAnswer = formatAnswer(answer.question, answer.correctAnswer);
                
                // 为每个题目序号创建点击元素
                tableHtml += `
                <tr>
                    <td>
                        <span class="question-number" 
                              onclick="showQuestionDetail(${index})">
                            ${index + 1}
                        </span>
                    </td>
                    <td>${answer.question.originalIndex}</td>
                    <td>${formattedUserAnswer}</td>
                    <td>${formattedCorrectAnswer}</td>
                    <td class="${answer.isCorrect ? 'correct' : 'incorrect'}">
                        ${answer.isCorrect ? '✓' : '✗'}
                    </td>
                </tr>`;
            });
            
            // 如果没有错题且只显示错题
            if (displayedCount === 0) {
                tableHtml += `<tr><td colspan="5" style="text-align: center; padding: 20px; color: #7f8c8d;">恭喜您！没有错题</td></tr>`;
            }
            
            tableHtml += '</table>';
            elements.detail.innerHTML = tableHtml;
        }

        // 显示题目详情（全局函数，确保能被onclick调用）
        window.showQuestionDetail = function(index) {
            if (index === undefined || !userAnswers || !userAnswers[index]) {
                console.error('无效的题目索引:', index);
                return;
            }
            
            const answerInfo = userAnswers[index];
            const question = answerInfo.question;
            
            // 格式化答案用于显示
            const formattedUserAnswer = formatAnswer(question, answerInfo.userAnswer);
            const formattedCorrectAnswer = formatAnswer(question, answerInfo.correctAnswer);
            
            // 构建题目详情HTML
            let detailHtml = `
                <p><strong>题型：</strong>${question.type}</p>
                <p><strong>原始题号：</strong>${question.originalIndex}</p>
                <p><strong>题目：</strong>${question.text}</p>
                <p><strong>选项：</strong></p>
                <ul>`;
            
            // 添加选项
            question.options.forEach(option => {
                const isCorrect = option.letter === question.answer;
                const isUserAnswer = answerInfo.userAnswer.includes(option.letter);
                let className = '';
                
                if (isCorrect) {
                    className = 'correct';
                } else if (isUserAnswer && !answerInfo.isCorrect) {
                    className = 'incorrect';
                }
                
                // 判断题选项显示格式化
                let displayLetter = option.letter;
                if (question.type === '判断') {
                    displayLetter = option.letter === 'A' ? 'T' : 'F';
                }
                
                detailHtml += `<li class="${className}">${displayLetter}. ${option.text} ${isCorrect ? '(正确答案)' : ''}</li>`;
            });
            
            detailHtml += `
                </ul>
                <div class="answer-info">
                    <p><strong>你的答案：</strong>${formattedUserAnswer || '未作答'}</p>
                    <p><strong>正确答案：</strong>${formattedCorrectAnswer}</p>
                    <p><strong>结果：</strong><span class="${answerInfo.isCorrect ? 'correct' : 'incorrect'}">${answerInfo.isCorrect ? '正确' : '错误'}</span></p>
                </div>`;
            
            // 更新模态框内容并显示
            elements.modalContent.innerHTML = detailHtml;
            elements.questionModal.style.display = 'flex';
        };

        // 复习错题
        function reviewWrongQuestions() {
            // 收集所有错题
            const wrongQuestions = userAnswers
                。filter(answer => !answer.isCorrect)
                。map(answer => answer.question);
            
            if (wrongQuestions.length === 0) {
                alert('恭喜！您没有错题需要复习');
                return;
            }
            
            // 设置当前题目为错题
            currentQuestions = wrongQuestions;
            currentIndex = 0;
            userScore = 0;
            userAnswers = [];
            
            // 隐藏结果区域，显示测验区域
            elements.resultSection.classList.add('hidden');
            elements.quizSection.classList.remove('hidden');
            elements.quizArea.classList.remove('hidden');
            
            elements.totalQuestions.textContent = currentQuestions.length;
            updateProgressBar();
            showCurrentQuestion();
        }

        // 隐藏模态框
        function hideModal() {
            elements.questionModal.style.display = 'none';
        }

        // 重新开始
        function restart() {
            elements.resultSection.classList.add('hidden');
            elements.uploadSection.classList.remove('hidden');
            elements.quizArea.classList.add('hidden');
            elements.fileInput.value = '';
            elements.fileName.textContent = '未选择文件';
        }

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
