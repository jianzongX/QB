<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>在线做题系统</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;max-width:800px;margin:0 auto;padding:20px;line-height:1.6}
        h1,h2{color:#333;text-align:center}
        .loading-section,.quiz-section,.result-section{background:#f9f9f9;padding:20px;margin-bottom:20px;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
        button{background:#4CAF50;color:#fff;border:none;padding:10px 15px;border-radius:4px;cursor:pointer;font-size:16px}
        button:hover{background:#45a049}
        .option{margin:8px 0}
        .correct{color:green;font-weight:bold}
        .incorrect{color:red}
        .score{font-size:24px;font-weight:bold;text-align:center;margin:20px 0}
        table{width:100%;border-collapse:collapse;margin:20px 0}
        th,td{border:1px solid #ddd;padding:8px;text-align:left}
        th{background:#f2f2f2}
        .hidden{display:none !important;}
        
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(76, 175, 80, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-container {
            text-align: center;
            padding: 20px;
        }
        
        /* 题目序号点击样式 */
        .question-number {
            color: #2196F3;
            cursor: pointer;
            text-decoration: underline;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .question-number:hover {
            color: #0b7dda;
            background-color: #e3f2fd;
        }
        
        /* 模态框样式 */
        #questionModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.2em;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            padding: 0;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .answer-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        /* 正确答案显示区域 */
        .correct-answer-display {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        
        .correct-answer-display strong {
            color: #2e7d32;
        }
        
        /* 范围选择样式 */
        .range-selection {
            margin: 15px 0;
            padding: 15px;
            background-color: #f1f8e9;
            border-radius: 5px;
        }
        
        .range-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        
        .range-inputs input {
            width: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .range-info {
            color: #555;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        /* 错误提示样式 */
        .error-message {
            color: #dc3545;
            padding: 15px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>在线做题系统（单选/多选/判断）</h1>

    <!-- 加载区域 -->
    <div id="loadingSection" class="loading-section">
        <div class="loading-container">
            <div class="loading"></div>
            <p>正在加载题库（1.xls）...</p>
        </div>
        <div id="errorMessage" class="error-message hidden"></div>
    </div>

    <div id="quizSection" class="quiz-section hidden">
        <h2>开始测试</h2>
        <div class="range-selection">
            <label><strong>请选择题目范围：</strong></label>
            <div class="range-inputs">
                <input type="number" id="startRange" min="1" value="1" placeholder="开始题号">
                <span>至</span>
                <input type="number" id="endRange" min="1" value="10" placeholder="结束题号">
            </div>
            <p class="range-info">当前题库共有 <span id="totalQuestionsCount">0</span> 道题（已跳过前两行标题）</p>
            <p class="range-info">提示：选择范围后，系统将在该范围内随机打乱顺序出题</p>
        </div>
        <button id="startQuizBtn">开始测试</button>

        <div id="quizArea" class="hidden">
            <p>题目 <span id="current">1</span> / <span id="total">10</span></p>
            <div id="questionText"></div>
            <div id="options" class="options"></div>
            
            <!-- 正确答案显示区域 -->
            <div id="correctAnswerDisplay" class="correct-answer-display hidden">
                <strong>正确答案：</strong><span id="correctAnswerText"></span>
            </div>
            
            <button id="submitBtn">提交答案</button>
            <button id="nextBtn" class="hidden">下一题</button>
        </div>
    </div>

    <div id="resultSection" class="result-section hidden">
        <h2>测试结果</h2>
        <div class="score">得分：<span id="score">0</span> / <span id="max">0</span></div>
        <!-- 新增错误题目统计提示 -->
        <p style="text-align:center; color:#666;">以下为错误题目统计（共 <span id="wrongCount">0</span> 道）</p>
        <div id="detail"></div>
        <button id="restartBtn">重新开始</button>
    </div>

    <!-- 题目详情模态框 -->
    <div id="questionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">题目详情</h3>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- 题目详情将在这里动态加载 -->
            </div>
            <button id="closeModalBtn">关闭</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // 全局变量
        let allQuestions = [];
        let currentQuestions = [];
        let currentIndex = 0;
        let userScore = 0;
        let userAnswers = [];

        // DOM 元素引用
        const elements = {
            loadingSection: document.getElementById('loadingSection'),
            errorMessage: document.getElementById('errorMessage'),
            quizSection: document.getElementById('quizSection'),
            resultSection: document.getElementById('resultSection'),
            // 范围选择元素
            startRange: document.getElementById('startRange'),
            endRange: document.getElementById('endRange'),
            totalQuestionsCount: document.getElementById('totalQuestionsCount'),
            // 其他元素
            startQuizBtn: document.getElementById('startQuizBtn'),
            quizArea: document.getElementById('quizArea'),
            currentQuestion: document.getElementById('current'),
            totalQuestions: document.getElementById('total'),
            questionText: document.getElementById('questionText'),
            options: document.getElementById('options'),
            submitBtn: document.getElementById('submitBtn'),
            nextBtn: document.getElementById('nextBtn'),
            score: document.getElementById('score'),
            maxScore: document.getElementById('max'),
            detail: document.getElementById('detail'),
            restartBtn: document.getElementById('restartBtn'),
            questionModal: document.getElementById('questionModal'),
            modalContent: document.getElementById('modalContent'),
            closeModal: document.getElementById('closeModal'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            // 正确答案显示区域
            correctAnswerDisplay: document.getElementById('correctAnswerDisplay'),
            correctAnswerText: document.getElementById('correctAnswerText'),
            // 新增错误题目计数元素
            wrongCount: document.getElementById('wrongCount')
        };

        // 初始化函数
        function init() {
            // 确保模态框默认隐藏
            elements.questionModal.style.display = 'none';
            // 绑定所有事件监听器
            bindEventListeners();
            // 直接加载同目录下的1.xls文件
            loadLocalExcelFile('1.xls');
        }

        // 绑定事件监听器
        function bindEventListeners() {
            // 开始测试按钮点击事件
            elements.startQuizBtn.addEventListener('click', startQuiz);
            
            // 提交答案按钮点击事件
            elements.submitBtn.addEventListener('click', submitAnswer);
            
            // 下一题按钮点击事件
            elements.nextBtn.addEventListener('click', goToNextQuestion);
            
            // 重新开始按钮点击事件
            elements.restartBtn.addEventListener('click', restart);
            
            // 关闭模态框按钮点击事件
            elements.closeModal.addEventListener('click', hideModal);
            elements.closeModalBtn.addEventListener('click', hideModal);
            
            // 点击模态框外部关闭
            elements.questionModal.addEventListener('click', function(e) {
                if (e.target === elements.questionModal) {
                    hideModal();
                }
            });
        }

        // 加载本地Excel文件（同目录下的1.xls）
        function loadLocalExcelFile(filePath) {
            fetch(filePath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`无法加载文件: ${response.statusText}`);
                    }
                    return response.arrayBuffer();
                })
                .then(data => {
                    try {
                        const wb = XLSX.read(new Uint8Array(data), { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        
                        // 处理题库数据，跳过前两行
                        allQuestions = processExcelData(rawData);
                        
                        if (allQuestions.length === 0) {
                            showError('未从Excel中解析到有效题目，请检查文件格式是否正确，题目应从第三行开始');
                            return;
                        }
                        
                        // 显示题库总题数
                        elements.totalQuestionsCount.textContent = allQuestions.length;
                        
                        // 默认范围设置为1到总题数或10（取较小值）
                        const defaultEnd = Math.min(allQuestions.length, 10);
                        elements.startRange.value = 1;
                        elements.endRange.value = defaultEnd;
                        
                        // 限制范围输入的最大值
                        elements.startRange.max = allQuestions.length;
                        elements.endRange.max = allQuestions.length;
                        
                        // 隐藏加载区域，显示测验区域
                        elements.loadingSection.classList.add('hidden');
                        elements.quizSection.classList.remove('hidden');
                    } catch (err) {
                        showError('解析文件失败: ' + err.message);
                    }
                })
                .catch(err => {
                    showError('加载文件时出错: ' + err.message + '<br>请确保1.xls文件与HTML文件在同一目录下');
                });
        }

        // 显示错误信息
        function showError(message) {
            elements.errorMessage.innerHTML = message;
            elements.errorMessage.classList.remove('hidden');
            // 隐藏加载动画
            document.querySelector('.loading').style.display = 'none';
            document.querySelector('.loading-container p').style.display = 'none';
        }

        // 处理Excel数据 - 跳过前两行，从第三行开始读取题目
        function processExcelData(data) {
            const questions = [];
            
            // 从索引2开始处理（第三行），跳过索引0（第一行）和索引1（第二行）
            for (let i = 2; i < data.length; i++) {
                const row = data[i];
                // 跳过空行或无效行
                if (!row || row.length < 3) continue;
                
                const type = (row[0] || '').trim();
                const text = row[1] || '';
                let answer = String(row[row.length - 1] || '').trim().toUpperCase();
                
                // 处理判断题答案转换
                if (type === '判断') {
                    if (answer === 'T' || answer === '对') {
                        answer = 'A';
                    } else if (answer === 'F' || answer === '错') {
                        answer = 'B';
                    }
                }
                
                const options = [];
                if (type === '判断') {
                    options.push({ letter: 'A', text: '对' });
                    options.push({ letter: 'B', text: '错' });
                } else {
                    let optIdx = 2;
                    while (optIdx < row.length - 1 && row[optIdx]) {
                        options.push({ 
                            letter: String.fromCharCode(65 + optIdx - 2), 
                            text: row[optIdx] 
                        });
                        optIdx++;
                    }
                }
                
                // 记录原始题号（从1开始计数，相对于题目内容）
                questions.push({ 
                    type, 
                    text, 
                    options, 
                    answer,
                    originalIndex: questions.length + 1 // 从1开始编号
                });
            }
            
            return questions;
        }

        // 格式化答案显示 - 判断题显示为A（T）、B（F）
        function formatAnswer(question, answer) {
            if (question.type === '判断') {
                // 替换A为A（T），B为B（F）
                return answer.replace(/A/g, 'A（T）').replace(/B/g, 'B（F）');
            }
            return answer;
        }

        // 开始测验 - 根据范围选择题目并打乱顺序
        function startQuiz() {
            // 获取用户选择的范围
            const start = parseInt(elements.startRange.value);
            const end = parseInt(elements.endRange.value);
            
            // 验证范围有效性
            if (isNaN(start) || isNaN(end) || start < 1 || end < 1) {
                alert('请输入有效的范围');
                return;
            }
            
            if (start > end) {
                alert('开始题号不能大于结束题号');
                return;
            }
            
            if (end > allQuestions.length) {
                alert(`结束题号不能大于题库总题数(${allQuestions.length})`);
                return;
            }
            
            // 根据范围筛选题目
            const filteredQuestions = allQuestions.filter(
                (q) => q.originalIndex >= start && q.originalIndex <= end
            );
            
            if (filteredQuestions.length === 0) {
                alert('所选范围内没有题目，请重新选择');
                return;
            }
            
            // 在筛选范围内打乱题目顺序
            currentQuestions = [...filteredQuestions].sort(() => Math.random() - 0.5);
            
            currentIndex = 0;
            userScore = 0;
            userAnswers = [];
            
            // 显示测验区域
            elements.quizArea.classList.remove('hidden');
            elements.totalQuestions.textContent = currentQuestions.length;
            showCurrentQuestion();
        }

        // 显示当前题目
        function showCurrentQuestion() {
            const question = currentQuestions[currentIndex];
            elements.currentQuestion.textContent = currentIndex + 1;
            elements.questionText.textContent = question.text;
            elements.options.innerHTML = '';
            
            // 隐藏正确答案显示区域和下一题按钮，显示提交按钮
            elements.correctAnswerDisplay.classList.add('hidden');
            elements.nextBtn.classList.add('hidden');
            elements.submitBtn.classList.remove('hidden');
            
            // 重置选项样式和状态
            question.options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                
                const input = document.createElement('input');
                input.type = question.type === '多项选择' ? 'checkbox' : 'radio';
                input.name = question.type === '多项选择' ? `ans-${currentIndex}` : 'ans';
                input.value = option.letter;
                input.id = `opt-${currentIndex}-${option.letter}`;
                
                const label = document.createElement('label');
                label.htmlFor = `opt-${currentIndex}-${option.letter}`;
                label.textContent = `${option.letter}. ${option.text}`;
                
                optionDiv.appendChild(input);
                optionDiv.appendChild(label);
                elements.options.appendChild(optionDiv);
            });
        }

        // 提交答案
        function submitAnswer() {
            const question = currentQuestions[currentIndex];
            let userAnswer = '';
            
            if (question.type === '多项选择') {
                const checkedOptions = [...document.querySelectorAll(`input[name="ans-${currentIndex}"]:checked`)];
                userAnswer = checkedOptions.map(opt => opt.value).sort().join('');
            } else {
                const selectedOption = document.querySelector('input[name="ans"]:checked');
                if (!selectedOption) {
                    alert('请选择答案');
                    return;
                }
                userAnswer = selectedOption.value;
            }
            
            // 验证答案
            const correctAnswer = question.answer.toUpperCase();
            const isCorrect = userAnswer === correctAnswer;
            
            // 记录答案 - 存储原始答案，显示时再格式化
            userAnswers.push({
                question: question,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect
            });
            
            // 更新分数
            if (isCorrect) {
                userScore++;
            } else {
                // 错误时显示格式化后的正确答案
                elements.correctAnswerText.textContent = formatAnswer(question, correctAnswer);
                elements.correctAnswerDisplay.classList.remove('hidden');
            }
            
            // 标记正确和错误答案
            question.options.forEach(option => {
                const label = document.querySelector(`label[for="opt-${currentIndex}-${option.letter}"]`);
                const input = document.querySelector(`input[id="opt-${currentIndex}-${option.letter}"]`);
                
                if (label && input) {
                    // 禁用所有选项，防止再次修改
                    input.disabled = true;
                    
                    if (option.letter === correctAnswer) {
                        label.classList.add('correct');
                    } else if (userAnswer.includes(option.letter)) {
                        label.classList.add('incorrect');
                    }
                }
            });
            
            // 隐藏提交按钮，显示下一题按钮
            elements.submitBtn.classList.add('hidden');
            elements.nextBtn.classList.remove('hidden');
        }

        // 前往下一题
        function goToNextQuestion() {
            currentIndex++;
            if (currentIndex < currentQuestions.length) {
                showCurrentQuestion();
            } else {
                showResults();
            }
        }

        // 显示结果（核心修改：仅渲染错误题目）
        function showResults() {
            // 隐藏测验区域，显示结果区域
            elements.quizSection.classList.add('hidden');
            elements.resultSection.classList.remove('hidden');
            
            // 更新分数
            elements.score.textContent = userScore;
            elements.maxScore.textContent = currentQuestions.length;
            
            // 筛选错误题目，统计错误数量
            const wrongAnswers = userAnswers.filter(answer => !answer.isCorrect);
            elements.wrongCount.textContent = wrongAnswers.length;
            
            // 生成错误题目表格（仅渲染错误题目）
            let tableHtml = '<table><tr><th>错误题序</th><th>原始题号</th><th>你的答案</th><th>正确答案</th><th>结果</th></tr>';
            
            wrongAnswers.forEach((answer, wrongIndex) => {
                // 对答案进行格式化显示
                const formattedUserAnswer = formatAnswer(answer.question, answer.userAnswer);
                const formattedCorrectAnswer = formatAnswer(answer.question, answer.correctAnswer);
                
                // 找到该错误题目在总答题记录中的原始索引（用于详情弹窗）
                const originalIndex = userAnswers.findIndex(item => item === answer);
                
                // 渲染错误题目行
                tableHtml += `
                <tr>
                    <td>
                        <span class="question-number" 
                              onclick="showQuestionDetail(${originalIndex})">
                            ${wrongIndex + 1}
                        </span>
                    </td>
                    <td>${answer.question.originalIndex}</td>
                    <td>${formattedUserAnswer}</td>
                    <td>${formattedCorrectAnswer}</td>
                    <td class="incorrect">✗</td>
                </tr>`;
            });
            
            // 若没有错误题目，显示提示文本
            if (wrongAnswers.length === 0) {
                tableHtml += '<tr><td colspan="5" style="text-align:center; color:#666;">恭喜！没有错误题目</td></tr>';
            }
            
            tableHtml += '</table>';
            elements.detail.innerHTML = tableHtml;
        }

        // 显示题目详情（全局函数，确保能被onclick调用）
        window.showQuestionDetail = function(index) {
            if (index === undefined || !userAnswers || !userAnswers[index]) {
                console.error('无效的题目索引:', index);
                return;
            }
            
            const answerInfo = userAnswers[index];
            const question = answerInfo.question;
            
            // 格式化答案用于显示
            const formattedUserAnswer = formatAnswer(question, answerInfo.userAnswer);
            const formattedCorrectAnswer = formatAnswer(question, answerInfo.correctAnswer);
            
            // 构建题目详情HTML
            let detailHtml = `
                <p><strong>题型：</strong>${question.type}</p>
                <p><strong>原始题号：</strong>${question.originalIndex}</p>
                <p><strong>题目：</strong>${question.text}</p>
                <p><strong>选项：</strong></p>
                <ul>`;
            
            // 添加选项
            question.options。forEach(option => {
                const isCorrect = option.letter === question.answer;
                const isUserAnswer = answerInfo。userAnswer。includes(option.letter);
                let className = '';
                
                if (isCorrect) {
                    className = 'correct';
                } else if (isUserAnswer && !answerInfo。isCorrect) {
                    className = 'incorrect';
                }
                
                // 判断题选项显示格式化
                let displayLetter = option。letter;
                if (question。输入 === '判断') {
                    displayLetter = option.letter === 'A' ? 'A（T）' : 'B（F）';
                }
                
                detailHtml += `<li class="${className}">${displayLetter}. ${option。text} ${isCorrect ? '(正确答案)' : ''}</li>`;
            });
            
            detailHtml += `
                </ul>
                <div class="answer-info">
                    <p><strong>你的答案：</strong>${formattedUserAnswer || '未作答'}</p>
                    <p><strong>正确答案：</strong>${formattedCorrectAnswer}</p>
                    <p><strong>结果：</strong><span class="${answerInfo。isCorrect ? 'correct' : 'incorrect'}">${answerInfo。isCorrect ? '正确' : '错误'}</span></p>
                </div>`;
            
            // 更新模态框内容并显示
            elements.modalContent.innerHTML = detailHtml;
            elements。questionModal。style.display = 'flex';
        };

        // 隐藏模态框
        function hideModal() {
            elements.questionModal.style.display = 'none';
        }

        // 重新开始
        function restart() {
            elements.resultSection.classList.add('hidden');
            elements.quizSection.classList.remove('hidden');
            elements.quizArea.classList.add('hidden');
        }

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
